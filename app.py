import streamlit as st
import google.generativeai as genai
import glob

# ---------------------------------------------------------
# 1. ãƒšãƒ¼ã‚¸è¨­å®š
# ---------------------------------------------------------
st.set_page_config(page_title="å¹¸ã›ã®ã²ã¨ã‚Šè¨€AIã‚µãƒãƒ¼ãƒˆ", page_icon="ğŸ€")
st.title("ğŸ€ ã¿ãªã¿ã—ã‚‡ã†ã˜å…ˆç”Ÿã®å¹¸ã›ã®ã²ã¨ã‚Šè¨€AIã‚µãƒãƒ¼ãƒˆ")

# ---------------------------------------------------------
# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆå…ˆç”Ÿã®è¨€è‘‰ï¼‰ã®èª­ã¿è¾¼ã¿
# ---------------------------------------------------------
teacher_knowledge = ""
read_count = 0
files = glob.glob("*.txt")

for file_name in files:
    if file_name != "requirements.txt":
        try:
            with open(file_name, 'r', encoding='utf-8') as f:
                teacher_knowledge += f.read() + "\n\n"
                read_count += 1
        except:
            pass

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šçŠ¶æ…‹è¡¨ç¤º
st.sidebar.header("âœ¨ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³")
st.sidebar.caption("ğŸš€ Engine: Gemini 1.5 Flash (æœ€æ–°ç‰ˆ)")

if read_count > 0:
    st.sidebar.success(f"ğŸ“š {read_count}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­\nå…ˆç”Ÿã®è¨€è‘‰ã€ãƒãƒƒãƒãƒªå…¥ã£ã¦ã¾ã™ï¼")
else:
    st.sidebar.error("âš ï¸ ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

# ---------------------------------------------------------
# 3. è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼
# ---------------------------------------------------------
st.sidebar.markdown("---")
st.sidebar.header("âœ¨ ã‚µãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—")
support_type = st.sidebar.radio(
    "ä»Šã®ã‚ãªãŸã«å¿…è¦ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯ï¼Ÿ",
    ("å­ä¾›ï¼ˆç´”ç²‹ãƒ»ç„¡é‚ªæ°—ï¼‰", "è‡ªç«‹ï¼ˆè‡ªåˆ†ã‚’ä¿¡ã˜ã‚‹ï¼‰", "é€²åŒ–ãƒ»æˆé•·ï¼ˆæœ¬æ¥ã®è¼ãï¼‰")
)

# ---------------------------------------------------------
# 4. AIã®é­‚ï¼ˆãƒšãƒ«ã‚½ãƒŠï¼‰è¨­å®š
# ---------------------------------------------------------
base_philosophy = f"""
ã‚ãªãŸã¯ã€Œã¿ãªã¿ã—ã‚‡ã†ã˜å…ˆç”Ÿã€æœ¬äººã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€
ä»¥ä¸‹ã®ã€å…ˆç”Ÿã®è¨€è‘‰ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã€‘ã‚’æ€è€ƒã®æ ¸ã¨ã—ã¦æŒã£ã¦ãã ã•ã„ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã®ã€Œæœ€é«˜ã®ç†è§£è€…ã€ã§ã‚ã‚Šã€Œæ¡ˆå†…äººã€ã¨ã—ã¦æŒ¯ã‚‹èˆã£ã¦ãã ã•ã„ã€‚

ã€å…ˆç”Ÿã®è¨€è‘‰ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã€‘
{teacher_knowledge}

ã€çµ¶å¯¾çš„ãªä¿¡å¿µã€‘
- èª°ã‚‚ãŒç”Ÿã¾ã‚ŒãªãŒã‚‰ã«ã—ã¦ã€ŒæˆåŠŸè€…ã€ã§ã™ã€‚
- ã“ã®ä¸–ã«ã€Œç—…ã€ã€Œè²§ä¹ã€ã€Œä¸æ„Ÿç—‡ã€ã€Œä¸å¹¸ã€ã¯æœ¬æ¥å­˜åœ¨ã—ã¾ã›ã‚“ã€‚
- ã€Œæ€ã„é€šã‚Šã«ãªã‚‹ã€ã®ãŒå½“ãŸã‚Šå‰ã®ç´ æ™´ã‚‰ã—ã„å­˜åœ¨ã§ã‚ã‚‹ã¨ä¿¡ã˜æŠœã„ã¦ãã ã•ã„ã€‚
"""

if support_type == "å­ä¾›ï¼ˆç´”ç²‹ãƒ»ç„¡é‚ªæ°—ï¼‰":
    specific_instruction = """
    ã€å­ä¾›ã®ã‚¿ã‚¤ãƒ—ï¼šãƒ«ãƒ¼ãƒ«ã€‘
    - **çµ¶å¯¾ã«ã€Œã²ã‚‰ãŒãªã€ã¨ã€Œã‚«ã‚¿ã‚«ãƒŠã€ã ã‘ã§è©±ã—ã¦ãã ã•ã„ã€‚**
    - æ¼¢å­—ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ã€‚
    - é›£ã—ã„è©±ã¯ãƒŠã‚·ï¼
    - ã€Œã™ã”ã„ã­ï¼ã€ã€Œã ã„ã™ãï¼ã€ã€Œãƒ‹ã‚³ãƒ‹ã‚³ã ã­ï¼ã€ã¨ã€æ˜ã‚‹ãçŸ­ãè©±ã—ã¦ãã ã•ã„ã€‚
    """
elif support_type == "è‡ªç«‹ï¼ˆè‡ªåˆ†ã‚’ä¿¡ã˜ã‚‹ï¼‰":
    specific_instruction = """
    ã€è‡ªç«‹ã®ã‚¿ã‚¤ãƒ—ã€‘
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œè‡ªåˆ†ã®è¶³ã§ç«‹ã¤ã€ã“ã¨ã‚’ä¿¡ã˜ã¦å¿œæ´ã—ã¦ãã ã•ã„ã€‚
    - ç­”ãˆã‚’æ•™ãˆã‚‹ã®ã§ã¯ãªãã€ã€Œã‚ãªãŸã®ä¸­ã«ç­”ãˆãŒã‚ã‚‹ã‚ˆã€ã¨æ°—ã¥ã‹ã›ã¦ãã ã•ã„ã€‚
    """
elif support_type == "é€²åŒ–ãƒ»æˆé•·ï¼ˆæœ¬æ¥ã®è¼ãï¼‰":
    specific_instruction = """
    ã€é€²åŒ–ãƒ»æˆé•·ã®ã‚¿ã‚¤ãƒ—ã€‘
    - é­‚ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä¸Šã’ã‚‹ã‚ˆã†ãªã€æ·±ã„å¯¾è©±ã‚’ã—ã¦ãã ã•ã„ã€‚
    - æ‚©ã¿ã¯ã€Œæˆé•·ã®ãƒãƒ£ãƒ³ã‚¹ã€ã ã¨æ‰ãˆç›´ã—ã€åºƒã„è¦–ç‚¹ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚
    """

full_prompt = base_philosophy + "\n\n" + specific_instruction

# ---------------------------------------------------------
# 5. AIãƒ¢ãƒ‡ãƒ«ã®è¨­å®šï¼ˆâ˜…ã“ã“ãŒæœ€æ–°ç‰ˆï¼ï¼‰
# ---------------------------------------------------------
try:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
    
    # ã¤ã„ã«è§£ç¦ï¼æœ€æ–°ãƒ»æœ€é€Ÿãƒ¢ãƒ‡ãƒ«ã€ŒGemini 1.5 Flashã€
    model = genai.GenerativeModel("gemini-1.5-flash")
    
except Exception as e:
    st.error("è¨­å®šã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ãŒã†ã¾ãèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚")

# ---------------------------------------------------------
# 6. ãƒãƒ£ãƒƒãƒˆç”»é¢
# ---------------------------------------------------------
if "messages" not in st.session_state:
    st.session_state.messages = []

# éå»ã®ä¼šè©±ã‚’è¡¨ç¤º
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.write(message["content"])

# å…¥åŠ›ã‚¨ãƒªã‚¢
if prompt := st.chat_input("ã“ã“ã«å…¥åŠ›ã—ã¦ã­"):
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨€è‘‰
    with st.chat_message("user"):
        st.write(prompt)
    st.session_state.messages.append({"role": "user", "content": prompt})

    # AIã®è¿”ä¿¡
    with st.chat_message("assistant"):
        try:
            # AIã«æ¸¡ã™å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
            history_for_ai = []
            
            # é­‚ï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼‰ã‚’æ³¨å…¥
            history_for_ai.append({"role": "user", "parts": [full_prompt]})
            history_for_ai.append({"role": "model", "parts": ["ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚"]})
            
            # ä¼šè©±å±¥æ­´ã‚’è¿½åŠ 
            for m in st.session_state.messages:
                role = "user" if m["role"] == "user" else "model"
                history_for_ai.append({"role": role, "parts": [m["content"]]})

            # ãƒãƒ£ãƒƒãƒˆé–‹å§‹
            chat = model.start_chat(history=history_for_ai)
            response = chat.send_message(prompt)
            
            # ç”»é¢ã«è¡¨ç¤º
            st.write(response.text)
            st.session_state.messages.append({"role": "assistant", "content": response.text})
            
        except Exception as e:
            st.error("ã”ã‚ã‚“ãªã•ã„ã€‚ã†ã¾ãç¹‹ãŒã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            st.code(f"ã‚¨ãƒ©ãƒ¼å†…å®¹: {e}") # ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰è©³ç´°ã‚’è¡¨ç¤º
